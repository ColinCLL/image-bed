name: è‡ªåŠ¨æ‰«æå›¾ç‰‡å¹¶æ›´æ–°ç½‘ç«™

on:
  push:
    branches: [ main ]
    paths:
      - '*.jpg'
      - '*.jpeg'
      - '*.png'
      - '*.gif'
      - '*.webp'
      - '*.bmp'
      - '*.tiff'
      - '*.tif'
  workflow_dispatch:

jobs:
  scan-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements.txt
        
    - name: æ‰«æå›¾ç‰‡æ–‡ä»¶
      run: |
        echo "å¼€å§‹æ‰«æå›¾ç‰‡æ–‡ä»¶..."
        python scan_images.py
        
    - name: æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡æ•°æ®æ›´æ–°
      id: check-changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡æ–‡ä»¶çš„å˜åŒ–ï¼ˆåŒ…æ‹¬åˆ é™¤ï¼‰
        if git diff --name-only HEAD~1 | grep -E '\.(jpg|jpeg|png|gif|webp|bmp|tiff|tif)$' > /dev/null; then
          echo "å‘ç°å›¾ç‰‡æ–‡ä»¶å˜åŒ–ï¼ˆåŒ…æ‹¬åˆ é™¤ï¼‰"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "æ²¡æœ‰å›¾ç‰‡æ–‡ä»¶å˜åŒ–"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: æ£€æŸ¥æ˜¯å¦ç”±Actionè§¦å‘
      id: check-action-trigger
      run: |
        # æ£€æŸ¥æœ€è¿‘çš„æäº¤æ˜¯å¦ç”±Actionè§¦å‘
        if git log --oneline -1 | grep -q "è‡ªåŠ¨æ›´æ–°å›¾ç‰‡æ•°æ®"; then
          echo "æ£€æµ‹åˆ°Actionè§¦å‘çš„æäº¤ï¼Œè·³è¿‡ä»¥é¿å…å¾ªç¯"
          echo "is_action_commit=true" >> $GITHUB_OUTPUT
        else
          echo "æ£€æµ‹åˆ°ç”¨æˆ·è§¦å‘çš„æäº¤"
          echo "is_action_commit=false" >> $GITHUB_OUTPUT
        fi
        
    - name: æäº¤æ›´æ–°çš„å›¾ç‰‡æ•°æ®
      if: steps.check-changes.outputs.has_changes == 'true' && steps.check-action-trigger.outputs.is_action_commit == 'false'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add images_data.json
        git add thumbnails/ || true
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å›¾ç‰‡æ•°æ®å’Œç¼©ç•¥å›¾ - $(date '+%Y-%m-%d %H:%M:%S')"
        git push origin HEAD:main
        
    - name: æ˜¾ç¤ºæ‰«æç»“æœ
      run: |
        if [ -f images_data.json ]; then
          echo "å›¾ç‰‡æ‰«æå®Œæˆï¼"
          echo "æ‰¾åˆ°çš„å›¾ç‰‡ï¼š"
          cat images_data.json | python -m json.tool
        else
          echo "æœªæ‰¾åˆ°å›¾ç‰‡æ•°æ®æ–‡ä»¶"
        fi
        
    - name: å‘é€é€šçŸ¥
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        echo "ç½‘ç«™å·²è‡ªåŠ¨æ›´æ–°ï¼"
        echo "æ¨¡ç‰¹å¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥æŸ¥çœ‹æœ€æ–°ä½œå“ï¼š"
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" 